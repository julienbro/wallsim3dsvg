<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WallSim3D - Simulateur de murs 3D</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Import map pour Three.js -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.155.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.155.0/examples/jsm/",
            "three/examples/jsm/controls/OrbitControls.js": "https://unpkg.com/three@0.155.0/examples/jsm/controls/OrbitControls.js",
            "three/examples/jsm/controls/TransformControls.js": "https://unpkg.com/three@0.155.0/examples/jsm/controls/TransformControls.js",
            "three/examples/jsm/loaders/FontLoader.js": "https://unpkg.com/three@0.155.0/examples/jsm/loaders/FontLoader.js",
            "three/examples/jsm/geometries/TextGeometry.js": "https://unpkg.com/three@0.155.0/examples/jsm/geometries/TextGeometry.js",
            "three/examples/jsm/loaders/OBJLoader.js": "https://unpkg.com/three@0.155.0/examples/jsm/loaders/OBJLoader.js",
            "three/addons/loaders/ColladaLoader.js": "https://unpkg.com/three@0.155.0/examples/jsm/loaders/ColladaLoader.js",
            "three/examples/jsm/loaders/GLTFLoader.js": "https://unpkg.com/three@0.155.0/examples/jsm/loaders/GLTFLoader.js",
            "three/addons/loaders/STLLoader.js": "https://unpkg.com/three@0.155.0/examples/jsm/loaders/STLLoader.js"
        }
    }
    </script>
</head>
<body>
    <!-- Écran de chargement -->
    <div id="splash-screen" class="splash-screen">
        <div class="splash-content">
            <div class="splash-logo">
                <img src="https://wallsim3d.com/logo/accueil.png" alt="WallSim3D">
            </div>
            <div class="splash-info">
                <!-- <h1>WallSim3D</h1> -->
                <!-- <p class="splash-version">Version 2.0.1</p> -->
                <button id="start-button" class="start-button">
                    <i class="fas fa-play"></i>
                    <span>Démarrer</span>
                </button>
                <div class="loading-section" id="loading-section" style="display: none;">
                    <div class="loading-bar">
                        <div class="loading-progress"></div>
                    </div>
                    <p class="loading-text" id="loading-text">Initialisation...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Barre de menu supérieure -->
        <div class="menubar">
            <div class="menu-item dropdown">
                <span>Fichier</span>
                <div class="dropdown-content">
                    <a href="#" id="new-project">Nouveau</a>
                    <a href="#" id="open-project">Ouvrir</a>
                    <a href="#" id="import-collada">Importer COLLADA (.dae)</a>
                    <a href="#" id="import-gltf">Importer GLTF/GLB (.gltf, .glb)</a>
                    <a href="#" id="import-stl">Importer STL (.stl)</a>
                    <a href="#" id="import-skp">Importer SketchUp (.skp)</a>
                    <a href="#" id="save-project">Enregistrer</a>
                    <a href="#" id="export-project">Exporter</a>
                </div>
            </div>
            <div class="menu-item dropdown">
                <span>Édition</span>
                <div class="dropdown-content">
                    <a href="#" id="undo">Annuler</a>
                    <a href="#" id="redo">Rétablir</a>
                    <a href="#" id="copy">Copier</a>
                    <a href="#" id="paste">Coller</a>
                    <a href="#" id="delete">Supprimer</a>
                </div>
            </div>
            <div class="menu-item dropdown">
                <span>Vue</span>
                <div class="dropdown-content">
                    <a href="#" id="view-top">Vue de dessus</a>
                    <a href="#" id="view-front">Vue de face</a>
                    <a href="#" id="view-right">Vue de droite</a>
                    <a href="#" id="view-iso">Vue isométrique</a>
                    <a href="#" id="toggle-grid">Afficher/Masquer grille</a>
                </div>
            </div>
            <div class="menu-item dropdown">
                <span>Style</span>
                <div class="dropdown-content">
                    <a href="#" id="style-elements-color">Élément en couleur</a>
                    <a href="#" id="style-elements-white">Élément en blancs</a>
                </div>
            </div>
            <div class="menu-item dropdown" id="dimension-scale-menu">
                <span>Échelle de cotation</span>
                <div class="dropdown-content" id="dimension-scale-dropdown">
                    <a href="#" class="scale-option" data-scale="1">1:1</a>
                    <a href="#" class="scale-option" data-scale="0.5">1:2</a>
                    <a href="#" class="scale-option" data-scale="0.2">1:5</a>
                    <a href="#" class="scale-option" data-scale="0.1">1:10</a>
                    <a href="#" class="scale-option" data-scale="0.05">1:20</a>
                    <a href="#" class="scale-option" data-scale="0.02">1:50</a>
                    <a href="#" class="scale-option" data-scale="0.01">1:100</a>
                    <a href="#" class="scale-option" data-scale="0.005">1:200</a>
                    <a href="#" class="scale-option" data-scale="0.002">1:500</a>
                </div>
            </div>
            <!-- Logo centré -->
            <div class="menu-logo">
                <img src="https://wallsim3d.com/logo/logo1.png" alt="Logo">
            </div>
            <!-- Ajout des boutons Annuler/Rétablir à droite -->
            <div style="margin-left:auto; display:flex; align-items:center; gap:4px;">
                <button class="toolbar-btn" id="toolbar-undo" data-tooltip="Annuler (Ctrl+Z)">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="toolbar-btn" id="toolbar-redo" data-tooltip="Rétablir (Ctrl+Y)">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        </div>

        <!-- Barre d'outils principale -->
        <div class="toolbar">
            <!-- Boutons Fichier -->
            <div class="toolbar-group">
                <button class="toolbar-btn" id="toolbar-new">
                    <i class="fas fa-file-plus"></i>
                    <span class="toolbar-btn-text">Nouveau</span>
                </button>
                <button class="toolbar-btn" id="toolbar-open">
                    <i class="fas fa-folder-open"></i>
                    <span class="toolbar-btn-text">Ouvrir</span>
                </button>
                <button class="toolbar-btn" id="toolbar-import-collada" title="Importer un fichier COLLADA (.dae)">
                    <i class="fas fa-file-import"></i>
                    <span class="toolbar-btn-text">Importer DAE</span>
                </button>
                <button class="toolbar-btn" id="toolbar-import-gltf" title="Importer un fichier GLTF/GLB (.gltf, .glb)">
                    <i class="fas fa-cube"></i>
                    <span class="toolbar-btn-text">Importer GLB</span>
                </button>
                <button class="toolbar-btn" id="toolbar-import-stl" title="Importer un fichier STL (.stl)">
                    <i class="fas fa-shapes"></i>
                    <span class="toolbar-btn-text">Importer STL</span>
                </button>
                <button class="toolbar-btn" id="toolbar-import-skp" title="Importer un fichier SketchUp (.skp)">
                    <i class="fas fa-draw-polygon"></i>
                    <span class="toolbar-btn-text">Importer SKP</span>
                </button>
                <button class="toolbar-btn" id="toolbar-save">
                    <i class="fas fa-save"></i>
                    <span class="toolbar-btn-text">Enregistrer</span>
                </button>
                <button class="toolbar-btn" id="toolbar-export">
                    <i class="fas fa-file-export"></i>
                    <span class="toolbar-btn-text">Exporter</span>
                </button>
                <button class="toolbar-btn" id="toolbar-export-view-pdf" title="Exporter la vue actuelle en PDF">
                    <i class="fas fa-camera"></i> <i class="fas fa-file-pdf" style="margin-left: -5px;"></i>
                    <span class="toolbar-btn-text">Vue PDF</span>
                </button>
            </div>
            
            <div class="toolbar-separator"></div>
            
            <!-- Boutons Édition -->
            <div class="toolbar-group">
                <button class="toolbar-btn" id="toolbar-copy">
                    <i class="fas fa-copy"></i>
                    <span class="toolbar-btn-text">Copier</span>
                </button>
                <button class="toolbar-btn" id="toolbar-cut">
                    <i class="fas fa-cut"></i>
                    <span class="toolbar-btn-text">Couper</span>
                </button>
                <button class="toolbar-btn" id="toolbar-paste">
                    <i class="fas fa-paste"></i>
                    <span class="toolbar-btn-text">Coller</span>
                </button>
                <button class="toolbar-btn" id="toolbar-delete">
                    <i class="fas fa-trash-alt"></i>
                    <span class="toolbar-btn-text">Supprimer</span>
                </button>
            </div>
            
            <div class="toolbar-separator"></div>
            
            <!-- Boutons Vue et Navigation -->
            <div class="toolbar-group">
                <button class="toolbar-btn" id="toolbar-zoom-in">
                    <i class="fas fa-search-plus"></i>
                    <span class="toolbar-btn-text">Zoom +</span>
                </button>
                <button class="toolbar-btn" id="toolbar-zoom-out">
                    <i class="fas fa-search-minus"></i>
                    <span class="toolbar-btn-text">Zoom -</span>
                </button>
                <button class="toolbar-btn" id="toolbar-zoom-extents">
                    <i class="fas fa-expand-arrows-alt"></i>
                    <span class="toolbar-btn-text">Tout voir</span>
                </button>
            </div>
            
            <div class="toolbar-separator"></div>
            
            <!-- Boutons Vues prédéfinies -->
            <div class="toolbar-group">
                <button class="toolbar-btn" id="toolbar-view-top">
                    <img class="view-icon-img" src="https://wallsim3d.com/icones/vue_dessus.png" alt="Vue dessus">
                    <span class="toolbar-btn-text">Dessus</span>
                </button>
                <button class="toolbar-btn" id="toolbar-view-iso">
                    <img class="view-icon-img" src="https://wallsim3d.com/icones/vue_3d.png" alt="Vue 3D">
                    <span class="toolbar-btn-text">3D</span>
                </button>
                <button class="toolbar-btn" id="toolbar-view-front">
                    <img class="view-icon-img" src="https://wallsim3d.com/icones/vue_face.png" alt="Vue face">
                    <span class="toolbar-btn-text">Face</span>
                </button>
                <button class="toolbar-btn" id="toolbar-view-back">
                    <img class="view-icon-img" src="https://wallsim3d.com/icones/vue_arriere.png" alt="Vue arrière">
                    <span class="toolbar-btn-text">Arrière</span>
                </button>
                <button class="toolbar-btn" id="toolbar-view-right">
                    <img class="view-icon-img" src="https://wallsim3d.com/icones/vue_droite.png" alt="Vue droite">
                    <span class="toolbar-btn-text">Droite</span>
                </button>
                <button class="toolbar-btn" id="toolbar-view-left">
                    <img class="view-icon-img" src="https://wallsim3d.com/icones/vue_gauche.png" alt="Vue gauche">
                    <span class="toolbar-btn-text">Gauche</span>
                </button>
                <button class="toolbar-btn" id="toolbar-view-orbit">
                    <i class="fas fa-globe"></i>
                    <span class="toolbar-btn-text">Orbite</span>
                </button>
                <button class="toolbar-btn" id="toolbar-snap">
                    <i class="fas fa-magnet"></i>
                    <span class="toolbar-btn-text">Aimant</span>
                </button>
            </div>
        </div>

        <!-- Zone principale -->
        <div class="main-area">
            <!-- Panneau latéral gauche -->
            <div class="sidebar">
                <div class="panel" id="tools-panel">
                    <div class="panel-header" style="display: none;">
                        <h3>Outils</h3>
                    </div>
                    <div class="panel-content">
                        <div class="tool-group-container">
                            <div class="tool-group-label">
                                <span>Outils</span>
                            </div>
                            <div class="tool-group">
                                <button class="tool-btn" id="sidebar-select" title="Sélectionner">
                                    <i class="fas fa-mouse-pointer"></i>
                                </button>
                                <button class="tool-btn" id="sidebar-polyline" title="Polyligne">
                                    <i class="fas fa-draw-polygon"></i>
                                </button>
                                <button class="tool-btn" id="sidebar-rect" title="Rectangle">
                                    <i class="fas fa-square"></i>
                                </button>
                                <button class="tool-btn" id="sidebar-circle" title="Cercle">
                                    <i class="fas fa-circle"></i>
                                </button>
                                <button class="tool-btn" id="sidebar-parallel" title="Parallèle">
                                    <i class="fas fa-grip-lines"></i>
                                </button>
                                <button class="tool-btn" id="sidebar-trim" title="Découper">
                                    <i class="fas fa-cut"></i>
                                </button>
                                <button class="tool-btn" id="sidebar-extend" title="Étendre">
                                    <i class="fas fa-expand-arrows-alt"></i>
                                </button>
                                <button class="tool-btn" id="sidebar-hatch" title="Hachures">
                                    <i class="fas fa-grip-lines-vertical"></i>
                                </button>
                                <button class="tool-btn" id="sidebar-surface" title="Créer surface">
                                    <i class="fas fa-fill"></i>
                                </button>
                                <button class="tool-btn" id="sidebar-extrude" title="Extruder">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="tool-btn" id="sidebar-dimension" title="Cotation">
                                    <i class="fas fa-ruler"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Zone de visualisation -->
            <div class="viewport-container">
                <div id="viewport"></div>
                
                <!-- Axes de coordonnées -->
                <div class="axis-indicator">
                    <canvas id="axis-helper" width="100" height="100"></canvas>
                </div>

                <!-- D-pad de contrôle -->
                <div class="dpad-container" id="dpad-container">
                    <div class="dpad-title">Déplacer</div>
                    <div class="dpad">
                        <button class="dpad-btn dpad-up" id="dpad-up" title="Haut (Y+)">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <button class="dpad-btn dpad-left" id="dpad-left" title="Gauche (X-)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="dpad-btn dpad-center" id="dpad-center" title="Réinitialiser Position">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <button class="dpad-btn dpad-right" id="dpad-right" title="Droite (X+)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button class="dpad-btn dpad-down" id="dpad-down" title="Bas (Y-)">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="dpad-vertical">
                        <button class="dpad-btn dpad-z-up" id="dpad-z-up" title="Monter (Z+)">
                            <i class="fas fa-arrow-up"></i> Z+
                        </button>
                        <button class="dpad-btn dpad-z-down" id="dpad-z-down" title="Descendre (Z-)">
                            <i class="fas fa-arrow-down"></i> Z-
                        </button>
                    </div>
                    <div class="dpad-step">
                        <label for="dpad-step-size">Pas:</label>
                        <input type="number" id="dpad-step-size" value="1" min="0.1" max="100" step="0.1">
                        <span>cm</span>
                    </div>
                </div>
                
                <!-- Barre d'état -->
                <div class="status-bar">
                    <span id="coordinates">X: 0.00, Y: 0.00, Z: 0.00</span>
                    <span id="mode-indicator">Mode: 2D</span>
                    <span id="snap-indicator">Accrochage: ON</span>
                    <button id="toggle-2d3d" class="btn-small">2D/3D</button>
                </div>
            </div>

            <!-- Barre latérale droite (multi-panneaux) -->
            <div class="right-sidebar" id="right-sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-panel="properties">
                        <i class="fas fa-cube"></i>
                        <span>Propriétés</span>
                    </button>
                    <button class="sidebar-tab" data-panel="data">
                        <i class="fas fa-database"></i>
                        <span>Données</span>
                    </button>
                    <button class="sidebar-tab" data-panel="textures">
                        <i class="fas fa-palette"></i>
                        <span>Textures</span>
                    </button>
                    <button class="sidebar-tab" data-panel="biblio">
                        <i class="fas fa-th-large"></i>
                        <span>Biblio</span>
                    </button>
                    <button class="sidebar-tab" data-panel="layers">
                        <i class="fas fa-layer-group"></i>
                        <span>Calques</span>
                    </button>
                    <button class="sidebar-tab" data-panel="sunlight">
                        <i class="fas fa-sun"></i>
                        <span>Soleil</span>
                    </button>
                    <button class="sidebar-tab" data-panel="history">
                        <i class="fas fa-history"></i>
                        <span>Historique</span>
                    </button>
                </div>
                
                <div class="sidebar-panels">
                    <!-- Panneau Propriétés -->
                    <div class="panel sidebar-panel active" id="properties-panel">
                        <div class="panel-header">
                            <h3>Propriétés</h3>
                            <button class="panel-toggle" title="Réduire">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="panel-content" id="properties-content">
                            <p>Sélectionnez un objet pour voir ses propriétés</p>
                        </div>
                    </div>

                    <!-- Panneau Données du Projet -->
                    <div class="panel sidebar-panel" id="data-panel" style="display: none;">
                        <div class="panel-header">
                            <h3>Données du Projet</h3>
                            <button class="panel-toggle" title="Réduire">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="panel-content" id="data-content">
                            <div class="data-section">
                                <div class="form-group">
                                    <label for="project-name">Nom du Projet:</label>
                                    <input type="text" id="project-name" class="data-input" value="Nouveau Projet">
                                </div>
                                <div class="form-group">
                                    <label for="project-client">Client:</label>
                                    <input type="text" id="project-client" class="data-input" value="">
                                </div>
                                <div class="form-group">
                                    <label for="project-address">Adresse du chantier:</label>
                                    <textarea id="project-address" class="data-textarea" rows="2"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="project-description">Description:</label>
                                    <textarea id="project-description" class="data-textarea" rows="3">Description du projet.</textarea>
                                </div>
                                <div class="form-group">
                                    <label for="project-designer">Dessinateur:</label>
                                    <input type="text" id="project-designer" class="data-input" value="Utilisateur">
                                </div>
                                <div class="form-group">
                                    <label for="procedure-template">Modèle de mode opératoire:</label>
                                    <select id="procedure-template" class="data-input">
                                        <option value="">-- Sélectionnez un modèle --</option>
                                        <option value="mur-demi-brique">Mur 1/2 brique épaisseur</option>
                                        <option value="mur-bloc-14">Mur bloc de 14</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="project-procedure">Mode opératoire:</label>
                                    <textarea id="project-procedure" class="data-textarea" rows="30" placeholder="Décrivez le mode opératoire détaillé..." style="min-height: 400px; font-family: 'Consolas', monospace; white-space: pre-wrap;"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="project-notes">Notes:</label>
                                    <textarea id="project-notes" class="data-textarea" rows="5" placeholder="Notes complémentaires..." style="min-height: 80px;"></textarea>
                                </div>
                                <div class="form-actions">
                                    <button id="save-project-data" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Enregistrer Données
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panneau Textures -->
                    <div class="panel sidebar-panel" id="textures-panel" style="display: none;">
                        <div class="panel-header">
                            <h3>Textures & Couleurs</h3>
                            <button class="panel-toggle" title="Réduire">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="panel-content">
                            <p id="texture-instruction">Sélectionnez une texture/couleur puis cliquez sur un objet pour l'appliquer</p>
                            
                            <!-- Onglets pour Textures et Couleurs -->
                            <div class="texture-tabs">
                                <button class="texture-tab active" data-tab="textures">Textures</button>
                                <button class="texture-tab" data-tab="colors">Couleurs</button>
                            </div>
                            
                            <!-- Contrôles d'ajustement -->
                            <div class="texture-controls" style="margin-bottom: 10px; display: none;" id="texture-controls">
                                <!-- ...existing code... -->
                            </div>
                            
                            <!-- Contenu des onglets -->
                            <div class="tab-content">
                                <!-- Onglet Textures -->
                                <div id="textures-tab" class="tab-panel active">
                                    <div id="texture-library" class="texture-grid">
                                        <!-- Les textures seront ajoutées dynamiquement -->
                                    </div>
                                </div>
                                
                                <!-- Onglet Couleurs -->
                                <div id="colors-tab" class="tab-panel" style="display: none;">
                                    <div class="color-section">
                                        <h4>Couleurs prédéfinies</h4>
                                        <div id="color-palette" class="color-grid">
                                            <!-- Les couleurs seront ajoutées dynamiquement -->
                                        </div>
                                    </div>
                                    
                                    <div class="color-section">
                                        <h4>Couleur personnalisée</h4>
                                        <div class="custom-color-controls">
                                            <input type="color" id="custom-color-picker" value="#ffffff">
                                            <button id="apply-custom-color" class="btn-small">Appliquer</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panneau Bibliothèque d'éléments -->
                    <div class="panel sidebar-panel" id="biblio-panel" style="display: none;">
                        <div class="panel-header">
                            <h3>Bibliothèque d'éléments</h3>
                            <button class="panel-toggle" title="Réduire">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="panel-content">
                            <button id="show-elements-library" class="btn" style="width: 100%; margin-bottom: 10px;">
                                <i class="fas fa-shapes"></i> Éléments de construction
                            </button>
                            
                            <!-- Section des éléments utilisés dans le modèle -->
                            <div class="section-separator" style="margin: 15px 0; border-top: 1px solid #ddd;"></div>
                            <div class="used-elements-section">
                                <h4 style="margin: 10px 0; font-size: 14px; color: #555;">Éléments utilisés dans le modèle</h4>
                                <div id="used-elements-list-display" class="used-elements-grid" style="
                                    display: grid;
                                    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                                    gap: 10px;
                                    margin-top: 10px;
                                    min-height: 50px;
                                ">
                                    <!-- Le contenu sera injecté par JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Modal pour la bibliothèque d'éléments -->
                            <div id="elements-modal" class="modal" style="display: none;">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h2>Bibliothèque d'éléments de construction</h2>
                                        <button class="modal-close" id="close-elements-modal">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="element-categories">
                                            <button class="category-tab active" data-category="briques">Briques</button>
                                            <button class="category-tab" data-category="blocs">Blocs</button>
                                            <button class="category-tab" data-category="linteaux">Linteaux</button>
                                            <button class="category-tab" data-category="isolants">Isolants</button>
                                            <button class="category-tab" data-category="planchers">Planchers</button>
                                            <button class="category-tab" data-category="autres">Autres</button>
                                        </div>
                                        <div id="elements-grid" class="elements-grid">
                                            <!-- Les éléments seront ajoutés dynamiquement -->
                                        </div>
                                        <div id="element-options" class="element-options" style="display: none;">
                                            <h3>Options de l'élément</h3>
                                            <div id="element-options-content">
                                                <!-- Options dynamiques selon l'élément -->
                                            </div>
                                            <button id="add-element-to-scene" class="btn" style="margin-top: 10px;">
                                                <i class="fas fa-plus"></i> Ajouter à la scène
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="selected-element-info" style="margin-top: 10px;">
                                <p style="color: #888; font-size: 11px;">Aucun élément sélectionné</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panneau Calques -->
                    <div class="panel sidebar-panel" id="layers-panel" style="display: none;">
                        <div class="panel-header">
                            <h3>Calques</h3>
                            <button class="panel-toggle" title="Réduire">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="panel-content">
                            <div id="layers-list"></div>
                            <button id="add-layer" class="btn" style="width: 100%; margin-top: 10px;">
                                <i class="fas fa-plus"></i> Nouveau calque
                            </button>
                        </div>
                    </div>
                    
                    <!-- Panneau Contrôle du soleil -->
                    <div id="sunlight-panel" class="sidebar-panel">
                        <div class="panel-header">
                            <h3>Éclairage solaire</h3>
                            <button class="panel-toggle"><i class="fas fa-chevron-up"></i></button>
                        </div>
                        <div class="panel-content">
                            <div class="control-group">
                                <label for="sun-month">Mois:</label>
                                <select id="sun-month">
                                    <option value="1">Janvier</option>
                                    <option value="2">Février</option>
                                    <option value="3">Mars</option>
                                    <option value="4">Avril</option>
                                    <option value="5">Mai</option>
                                    <option value="6" selected>Juin</option>
                                    <option value="7">Juillet</option>
                                    <option value="8">Août</option>
                                    <option value="9">Septembre</option>
                                    <option value="10">Octobre</option>
                                    <option value="11">Novembre</option>
                                    <option value="12">Décembre</option>
                                </select>
                            </div>
                            
                            <div class="control-group">
                                <label for="sun-hour">Heure: <span id="hour-display">12h</span></label>
                                <input type="range" id="sun-hour" min="6" max="18" value="12" step="0.5">
                            </div>
                            
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="show-sun-helper"> Afficher l'indicateur solaire
                                </label>
                            </div>
                            
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="enable-shadows" checked> Activer les ombres
                                </label>
                            </div>
                            
                            <!-- Contrôles du Nord -->
                            <div class="control-group north-controls">
                                <h4><i class="fas fa-compass"></i> Orientation du Nord</h4>
                                
                                <div class="control-group">
                                    <label>
                                        <input type="checkbox" id="show-north-indicator"> 
                                        Afficher l'indicateur Nord
                                    </label>
                                </div>
                                
                                <div class="control-group">
                                    <label for="north-angle">Angle: <span id="north-angle-display">0°</span></label>
                                    <input type="range" id="north-angle" min="0" max="359" value="0" step="1">
                                </div>
                                
                                <div class="control-group">
                                    <label for="north-angle-input">Valeur précise:</label>
                                    <input type="number" id="north-angle-input" min="0" max="359" value="0" step="0.1">
                                </div>
                                
                                <div class="preset-directions">
                                    <h5>Orienter le Nord à</h5>
                                    <div class="direction-buttons">
                                        <button class="direction-btn" data-angle="0">Nord</button>
                                        <button class="direction-btn" data-angle="90">Est</button>
                                        <button class="direction-btn" data-angle="180">Sud</button>
                                        <button class="direction-btn" data-angle="270">Ouest</button>
                                    </div>
                                </div>
                                
                                <div class="compass-info">
                                    <small>
                                        0°=Nord • 90°=Est • 180°=Sud • 270°=Ouest
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panneau Historique -->
                    <div class="panel sidebar-panel" id="history-panel" style="display: none;">
                        <div class="panel-header">
                            <h3>Historique</h3>
                            <button class="panel-toggle" title="Réduire">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="panel-content">
                            <div id="history-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ligne de commande -->
        <div class="command-line">
            <span class="command-prompt">Commande:</span>
            <input type="text" id="command-input" placeholder="Entrez une commande...">
            <div id="command-output"></div>
        </div>
    </div>

    <!-- Chargement des scripts avec type="module" -->
    <script type="module" src="app.js"></script>
    <script src="js/managers/UsedElementsManager.js"></script>
    
    <script>
    // Variable globale pour stocker l'outil actuel
    window.lastUsedTool = 'select';

    // Ajout d'une fonction globale pour supprimer tous les Hourdis (anti-erreur)
    window.obliterateAllHourdis = function() {
        if (!window.trackedConstructionElements) return;
        let before = window.trackedConstructionElements.length;
        window.trackedConstructionElements = window.trackedConstructionElements.filter(element => {
            if (!element || !element.name) return true;
            const name = element.name.toLowerCase();
            return !(name.includes('hourdis') || name.includes('13+6'));
        });
        let after = window.trackedConstructionElements.length;
        if (before !== after) {
            console.log(`obliterateAllHourdis: ${before - after} Hourdis supprimés`);
            if (window.updateUsedElementsDisplay) window.updateUsedElementsDisplay();
        }
        // Remove from scene if needed
        if (window.app && window.app.scene) {
            let toRemove = [];
            window.app.scene.traverse(obj => {
                if (obj.userData && obj.userData.elementType) {
                    const name = obj.userData.elementType.toLowerCase();
                    if (name.includes('hourdis') || name.includes('13+6')) {
                        toRemove.push(obj);
                    }
                }
            });
            toRemove.forEach(obj => {
                if (obj.parent) obj.parent.remove(obj);
                // Remove from app.objects and layers if present
                if (window.app.objects) {
                    window.app.objects = window.app.objects.filter(o => o !== obj);
                }
                if (window.app.layers && window.app.currentLayer && window.app.layers[window.app.currentLayer]?.objects) {
                    window.app.layers[window.app.currentLayer].objects =
                        window.app.layers[window.app.currentLayer].objects.filter(o => o !== obj);
                }
            });
        }
        // Optionally, show feedback
        if (window.commandOutput || document.getElementById('command-output')) {
            (window.commandOutput || document.getElementById('command-output')).textContent =
                "Tous les éléments Hourdis ont été supprimés.";
        }
    };

    // Fonction pour activer le mode orbite
    function activateOrbitMode() {
        if (window.app && window.app.controls) {
            window.app.controls.enabled = true;
            const orbitBtn = document.getElementById('toolbar-view-orbit');
            orbitBtn?.classList.add('active');
            console.log('Mode orbite activé automatiquement');
        }
    }
    
    // Fonction pour désactiver le mode orbite
    function deactivateOrbitMode() {
        if (window.app && window.app.controls) {
            window.app.controls.enabled = false;
            const orbitBtn = document.getElementById('toolbar-view-orbit');
            orbitBtn?.classList.remove('active');
            console.log('Mode orbite désactivé automatiquement');
        }
    }
    
    // Ajouter la méthode manquante immédiatement
    window.addEventListener('load', () => {
        // Intercepter les changements d'outils avec possibilité de désélection
        setTimeout(() => {
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const toolId = this.id.replace('sidebar-', '');
                    
                    // Si c'est le bouton sélectionner, toujours l'activer et désactiver les autres
                    if (toolId === 'select') {
                        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        window.lastUsedTool = 'select';
                        // Désactiver le mode orbite quand on passe en mode sélection
                        deactivateOrbitMode();
                        if (window.app && window.app.setTool) {
                            window.app.setTool('select');
                        }
                        console.log('Mode sélection activé');
                    } else {
                        // Pour les autres outils, permettre la désélection
                        if (this.classList.contains('active') && toolId === window.lastUsedTool) {
                            // Désélectionner l'outil actuel et activer le mode orbite
                            this.classList.remove('active');
                            window.lastUsedTool = 'orbit';
                            if (window.app && window.app.setTool) {
                                window.app.setTool('select');
                            }
                            activateOrbitMode();
                            console.log('Outil désélectionné, passage en mode orbite');
                        } else {
                            // Activer le nouvel outil et désactiver le mode orbite
                            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            window.lastUsedTool = toolId;
                            // Désactiver le mode orbite quand on sélectionne un outil de dessin
                            deactivateOrbitMode();
                            console.log('Outil sélectionné:', toolId);
                        }
                    }
                });
            });
            
            // Activer le mode sélection par défaut
            document.getElementById('sidebar-select')?.classList.add('active');
        }, 1000);
        
        // Vérifier périodiquement jusqu'à ce que UIManager soit disponible
        const checkInterval = setInterval(() => {
            if (window.app && window.app.uiManager) {
                if (!window.app.uiManager.updateHistoryPanel) {
                    window.app.uiManager.updateHistoryPanel = function() {
                        console.log('updateHistoryPanel appelé (méthode temporaire)');
                        const historyList = document.getElementById('history-list');
                        if (historyList) {
                            // Mettre à jour même si le panneau n'est pas visible
                            if (window.app.history && window.app.history.length > 0) {
                                historyList.innerHTML = '';
                                

                                window.app.history.forEach((item, index) => {
                                    const historyItem = document.createElement('div');
                                    historyItem.style.cssText = 'padding: 8px 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 12px; transition: background-color 0.2s;';
                                    
                                    // Déterminer le texte à afficher
                                    let actionText = 'Action';
                                    
                                    // Utiliser 'action' au lieu de 'type' car c'est ce qui est dans l'historique
                                    const itemAction = item.action || item.type || '';
                                    
                                    if (itemAction === 'create') {
                                        // Utiliser l'outil stocké ou le dernier outil utilisé
                                        const toolUsed = item.tool || window.lastUsedTool || window.app.currentTool;
                                        
                                        switch(toolUsed) {
                                            case 'rect':
                                            case 'rectangle':
                                                actionText = 'Rectangle créé';
                                                break;
                                            case 'circle':
                                                actionText = 'Cercle créé';
                                                break;
                                            case 'arc':
                                                actionText = 'Arc créé';
                                                break;
                                            case 'polyline':
                                                actionText = 'Polyligne créée';
                                                break;
                                            case 'line':
                                                actionText = 'Ligne créée';
                                                break;
                                            case 'parallel':
                                                actionText = 'Parallèle créée';
                                                break;
                                            default:
                                                actionText = 'Objet créé';
                                        }
                                    } else if (itemAction === 'extrude') {
                                        actionText = 'Extrusion appliquée';
                                    } else if (itemAction === 'delete') {
                                        actionText = 'Objet supprimé';
                                    } else if (itemAction === 'move') {
                                        actionText = 'Objet déplacé';
                                    } else if (itemAction === 'rotate') {
                                        actionText = 'Objet pivoté';
                                    } else if (itemAction === 'scale') {
                                        actionText = 'Échelle modifiée';
                                    } else if (itemAction === 'texture') {
                                        actionText = 'Texture appliquée';
                                    } else if (itemAction === 'color') {
                                        actionText = 'Couleur appliquée';
                                    } else if (itemAction === 'element') {
                                        // Pour les éléments de construction
                                        if (item.elementType) {
                                            actionText = `${item.elementType} ajouté`;
                                        } else {
                                            actionText = 'Élément ajouté';
                                        }
                                    } else if (itemAction && itemAction.length > 0) {
                                        // Utiliser l'action directement si elle n'est pas reconnue
                                        actionText = itemAction.charAt(0).toUpperCase() + itemAction.slice(1);
                                    }
                                    
                                    historyItem.innerHTML = `
                                        <div style="font-weight: bold; color: #333;">${index + 1}. ${actionText}</div>
                                        ${item.timestamp ? `<div style="font-size: 10px; color: #666; margin-top: 2px;">${new Date(item.timestamp).toLocaleTimeString()}</div>` : ''}
                                    `;
                                    historyItem.onmouseenter = function() { this.style.backgroundColor = '#f5f5f5'; };
                                    historyItem.onmouseleave = function() { this.style.backgroundColor = 'transparent'; };
                                    historyItem.onclick = () => {
                                        console.log('Historique item cliqué:', index, item);
                                    };
                                    historyList.appendChild(historyItem);
                                });
                            } else {
                                historyList.innerHTML = '<p style="text-align: center; color: #999; font-size: 12px; padding: 20px;">Aucune action dans l\'historique</p>';
                            }
                        }
                    };
                    
                    // Intercepter la méthode addToHistory pour ajouter l'outil actuel
                    setTimeout(() => {
                        if (window.app && window.app.addToHistory) {
                            const originalAddToHistory = window.app.addToHistory.bind(window.app);
                            window.app.addToHistory = function(action, data = {}) {
                                // Ajouter l'outil actuel aux données
                                const enhancedData = {
                                    ...data,
                                    tool: window.lastUsedTool || window.app.currentTool
                                };
                                
                                // Si c'est une création d'objet, activer le mode orbite
                                if (action === 'create') {
                                    setTimeout(() => {
                                        // Désélectionner tous les outils de la sidebar
                                        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                                        window.lastUsedTool = 'orbit';
                                        activateOrbitMode();
                                        console.log('Objet créé, passage automatique en mode orbite');
                                    }, 100);
                                }
                                
                                return originalAddToHistory(action, enhancedData);
                            };
                            console.log('Méthode addToHistory interceptée');
                        }
                    }, 2000);
                    
                    console.log('Méthode updateHistoryPanel ajoutée à UIManager');
                }
                clearInterval(checkInterval);
            }
        }, 10); // Vérifier toutes les 10ms
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        // INTERCEPTEUR ULTRA-PRÉCOCE pour empêcher tout Hourdis
        if (window.trackedConstructionElements) {
            // Créer un proxy pour surveiller toutes les modifications
            window.trackedConstructionElements = new Proxy(window.trackedConstructionElements || [], {
                set(target, property, value) {
                    // Bloquer l'ajout de tout élément Hourdis
                    if (value && value.name && typeof value.name === 'string') {
                        const name = value.name.toLowerCase();
                        if (name.includes('hourdis') || name.includes('13+6')) {
                            console.log('PROXY BLOCAGE HOURDIS:', value.name);
                            return true; // Prétendre que l'opération a réussi mais ne rien faire
                        }
                    }
                    target[property] = value;
                    return true;
                }
            });
        }
        
        // Système de tracking des éléments de construction avec FILTRAGE ANTI-HOURDIS
        window.trackedConstructionElements = window.trackedConstructionElements || [];

        const elementDisplayInfo = {
            // Briques spécifiques
            'Brique M50': { name: 'Brique M50', icon: '🧱' },
            'Brique M57': { name: 'Brique M57', icon: '🧱' },
            'Brique M65': { name: 'Brique M65', icon: '🧱' },
            'Brique M90': { name: 'Brique M90', icon: '🧱' },
            'Brique WF': { name: 'Brique WF', icon: '🧱' },
            'Brique WFD': { name: 'Brique WFD', icon: '🧱' },
            
            // Blocs spécifiques
            'Bloc creux B9': { name: 'Bloc B9', icon: '⬜' },
            'Bloc creux B14': { name: 'Bloc B14', icon: '⬜' },
            'Bloc creux B19': { name: 'Bloc B19', icon: '⬜' },
            'Bloc creux B29': { name: 'Bloc B29', icon: '⬜' },
            'Bloc B9': { name: 'Bloc B9', icon: '⬜' },
            'Bloc B14': { name: 'Bloc B14', icon: '⬜' },
            'Bloc B19': { name: 'Bloc B19', icon: '⬜' },
            'Bloc B29': { name: 'Bloc B29', icon: '⬜' },
            'Bloc Argex 39x9x19': { name: 'Bloc Argex 9', icon: '⬜' },
            'Bloc Argex 39x14x19': { name: 'Bloc Argex 14', icon: '⬜' },
            'Bloc Argex 39x19x19': { name: 'Bloc Argex 19', icon: '⬜' },
            'Bloc béton cell. 5cm': { name: 'Béton Cell. 5cm', icon: '⬜' },
            'Bloc béton cell. 7cm': { name: 'Béton Cell. 7cm', icon: '⬜' },
            'Bloc béton cell. 10cm': { name: 'Béton Cell. 10cm', icon: '⬜' },
            'Bloc béton cell. 15cm': { name: 'Béton Cell. 15cm', icon: '⬜' },
            'Bloc béton cell. 17.5cm': { name: 'Béton Cell. 17.5cm', icon: '⬜' },
            'Bloc béton cell. 20cm': { name: 'Béton Cell. 20cm', icon: '⬜' },
            'Bloc béton cell. 24cm': { name: 'Béton Cell. 24cm', icon: '⬜' },
            'Stepoc15N': { name: 'Stepoc15N', icon: '⬜' },
            
            // SECTION PLANCHERS VIDE - TOUT HOURDIS SUPPRIMÉ
            
            // Linteaux spécifiques
            'Linteau Béton L100': { name: 'Linteau Béton L100', icon: '🧱' },
            'Linteau Béton L120': { name: 'Linteau Béton L120', icon: '🧱' },
            'Linteau Béton L140': { name: 'Linteau Béton L140', icon: '🧱' },
            'Linteau Béton L160': { name: 'Linteau Béton L160', icon: '🧱' },
            'Linteau Béton L180': { name: 'Linteau Béton L180', icon: '🧱' },
            'Linteau Béton L200': { name: 'Linteau Béton L200', icon: '🧱' },
            'Linteau Béton L220': { name: 'Linteau Béton L220', icon: '🧱' },
            'Linteau Béton L240': { name: 'Linteau Béton L240', icon: '🧱' },
            'Linteau Béton L260': { name: 'Linteau Béton L260', icon: '🧱' },
            'Linteau Béton L280': { name: 'Linteau Béton L280', icon: '🧱' },
            'Linteau Béton L300': { name: 'Linteau Béton L300', icon: '🧱' },
            'Linteau Béton L320': { name: 'Linteau Béton L320', icon: '🧱' },
            'Linteau Béton L340': { name: 'Linteau Béton L340', icon: '🧱' },
            'Linteau Béton L360': { name: 'Linteau Béton L360', icon: '🧱' },
            'Linteau Béton L380': { name: 'Linteau Béton L380', icon: '🧱' },
            'Linteau Béton L400': { name: 'Linteau Béton L400', icon: '🧱' },
            'Linteau Béton L420': { name: 'Linteau Béton L420', icon: '🧱' },
            'Linteau Béton L440': { name: 'Linteau Béton L440', icon: '🧱' },
            'Linteau Béton L460': { name: 'Linteau Béton L460', icon: '🧱' },
            'Linteau Béton L480': { name: 'Linteau Béton L480', icon: '🧱' },
            'Linteau Béton L500': { name: 'Linteau Béton L500', icon: '🧱' },
            
            // Nouveaux blocs B
            'Bloc B9': { name: 'Bloc B9', icon: '⬜' },
            'Bloc B14': { name: 'Bloc B14', icon: '⬜' },
            'Bloc B19': { name: 'Bloc B19', icon: '⬜' },
            'Bloc B29': { name: 'Bloc B29', icon: '⬜' },
            'Bloc Argex 39x9x19': { name: 'Bloc Argex 9', icon: '⬜' },
            'Bloc Argex 39x14x19': { name: 'Bloc Argex 14', icon: '⬜' },
            'Bloc Argex 39x19x19': { name: 'Bloc Argex 19', icon: '⬜' },
            
            // Nouveaux linteaux
            'Linteau L120_14': { name: 'Linteau L120_14', icon: '🧱' },
            'Linteau L140_14': { name: 'Linteau L140_14', icon: '🧱' },
            'Linteau L160_14': { name: 'Linteau L160_14', icon: '🧱' },
            'Linteau L180_14': { name: 'Linteau L180_14', icon: '🧱' },
            'Linteau L200_14': { name: 'Linteau L200_14', icon: '🧱' },
            
            // Nouveaux isolants
            'Isolant PUR5': { name: 'Isolant PUR5', icon: '🟡' },
            'Isolant PUR6': { name: 'Isolant PUR6', icon: '🟡' },
            'Isolant PUR7': { name: 'Isolant PUR7', icon: '🟡' },
            
            // Nouveaux autres
            'Vide': { name: 'Vide', icon: '⬜' },
            'Profil': { name: 'Profil', icon: '📏' },
        };

        // FILTRE ANTI-HOURDIS pour la fonction updateUsedElementsDisplay
        function updateUsedElementsDisplay() {
            const container = document.getElementById('used-elements-list-display');
            if (!container) {
                console.warn('Used elements container not found.');
                return;
            }
            if (!window.trackedConstructionElements) {
                window.trackedConstructionElements = [];
            }
            
            // ÉTAPE 1: FILTRAGE PRÉALABLE ULTRA-AGRESSIF
            window.trackedConstructionElements = window.trackedConstructionElements.filter(element => {
                if (!element || !element.name) return false;
                const name = element.name.toLowerCase();
                const isHourdis = name.includes('hourdis') || 
                                 name.includes('13+6') || 
                                 (name.includes('13') && name.includes('6'));
                if (isHourdis) {
                    console.log('ÉTAPE 1 - HOURDIS DÉTECTÉ ET SUPPRIMÉ:', element.name);
                    return false;
                }
                return true;
            });
            
            container.innerHTML = '';
            const displayedElementIds = new Set();

            // ÉTAPE 2: DOUBLE VÉRIFICATION À L'AFFICHAGE
            window.trackedConstructionElements.forEach(elementData => {
                if (!elementData || !elementData.id || displayedElementIds.has(elementData.id)) {
                    return;
                }
                
                // ÉTAPE 3: TRIPLE VÉRIFICATION ANTI-HOURDIS AVANT AFFICHAGE
                if (elementData.name) {
                    const name = elementData.name.toLowerCase();
                    if (name.includes('hourdis') || name.includes('13+6') || (name.includes('13') && name.includes('6'))) {
                        console.log('ÉTAPE 3 - HOURDIS BLOQUÉ à l\'affichage:', elementData.name);
                        return;
                    }
                }
                
                displayedElementIds.add(elementData.id);

                const item = document.createElement('div');
                item.className = 'used-element-item';
                
                const dims = elementData.dims || {};
                const dimText = `${dims.x ? dims.x.toFixed(1) : '?'}×${dims.z ? dims.z.toFixed(1) : '?'}×${dims.y ? dims.y.toFixed(1) : '?'} cm`;
                
                const elementInfo = elementDisplayInfo[elementData.name] || { icon: '📦', name: elementData.name || 'Element' };
                const icon = elementData.icon || elementInfo.icon || '📦';
                const displayName = elementData.name || elementInfo.name || 'Element';
                
                item.innerHTML = `
                    <div style="font-size: 18px; margin-bottom: 4px;">${icon}</div>
                    <span class="element-full-name">${displayName}</span> 
                    <span class="element-dimensions">${dimText}</span>
                `;
                
                item.addEventListener('click', () => {
                    // ÉTAPE 4: VÉRIFICATION FINALE AVANT INSERTION
                    if (elementData.name) {
                        const name = elementData.name.toLowerCase();
                        if (name.includes('hourdis') || name.includes('13+6')) {
                            console.log('BLOCAGE FINAL - Tentative d\'insertion Hourdis bloquée:', elementData.name);
                            return;
                        }
                    }
                    
                    // Try multiple access methods for UIManager
                    let uiManager = null;
                    if (window.app && window.app.uiManager) {
                        uiManager = window.app.uiManager;
                    } else if (window.uiManager) {
                        uiManager = window.uiManager;
                    }
                    
                    if (uiManager && uiManager.insertElementByType) {
                        uiManager.insertElementByType(elementData.name, { 
                            category: elementData.category, 
                            dims: elementData.dims
                        });
                    } else {
                        console.warn('UIManager or insertElementByType not available');
                        // Fallback: try to access through global scope
                        if (typeof insertElementByType === 'function') {
                            insertElementByType(elementData.name, { 
                                category: elementData.category, 
                                dims: elementData.dims
                            });
                        } else {
                            // Show user feedback
                            document.getElementById('command-output').textContent = 'Erreur: Impossible d\'insérer l\'élément';
                        }
                    }
                });
                
                container.appendChild(item);
            });
            
            if (displayedElementIds.size === 0) {
                container.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: #999; font-size: 12px;">Aucun élément utilisé dans le modèle</p>`;
            }
        }

        window.updateUsedElementsDisplay = updateUsedElementsDisplay;

        function addTrackedElementWithUUID(elementType, uuid) {
            if (elementType && uuid) {
                if (!window.trackedConstructionElements.find(el => el.id === uuid)) {
                    window.trackedConstructionElements.push({ type: elementType, id: uuid });
                    updateUsedElementsDisplay();
                }
            }
        }

        function removeTrackedElementByUUID(uuid) {
            const initialLength = window.trackedConstructionElements.length;
            window.trackedConstructionElements = window.trackedConstructionElements.filter(el => el.id !== uuid);
            if (window.trackedConstructionElements.length < initialLength) {
                updateUsedElementsDisplay();
            }
        }

        // Intercepter les ajouts/suppressions à la scène
        let sceneReadyCheckInterval = setInterval(() => {
            if (window.app && window.app.scene && typeof window.app.scene.add === 'function') {
                clearInterval(sceneReadyCheckInterval);

                const originalSceneAdd = window.app.scene.add;
                window.app.scene.add = function(...objects) {
                    objects.forEach(obj => {
                        if (obj && obj.uuid && obj.userData && obj.userData.isConstructionElement && obj.userData.elementType) {
                            // Correction : utiliser CSS.escape pour éviter les erreurs de sélecteur
                            let wrapper3d = null;
                            if (window.document && typeof CSS !== "undefined" && CSS.escape) {
                                try {
                                    const safeType = CSS.escape(obj.userData.elementType);
                                    wrapper3d = document.querySelector(`.3d-wrapper[data-type="${safeType}"]`);
                                } catch (e) {
                                    wrapper3d = null;
                                }
                            }
                            let preview = obj.userData.elementPreview || null;
                            window.trackedConstructionElements.push({
                                type: obj.userData.elementType,
                                id: obj.uuid,
                                preview: preview,
                                wrapper3d: wrapper3d
                            });
                            updateUsedElementsDisplay();
                        }
                    });
                    return originalSceneAdd.apply(this, objects);
                };

                const originalSceneRemove = window.app.scene.remove;
                window.app.scene.remove = function(...objects) {
                    objects.forEach(obj => {
                        if (obj && obj.uuid && obj.userData && obj.userData.isConstructionElement) {
                            window.trackedConstructionElements = window.trackedConstructionElements.filter(el => el.id !== obj.uuid);
                            updateUsedElementsDisplay();
                        }
                    });
                    return originalSceneRemove.apply(this, objects);
                };
                
                updateUsedElementsDisplay();
            }
        }, 200);
        
        setTimeout(() => clearInterval(sceneReadyCheckInterval), 10000);

        // Gestion des onglets de la sidebar
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.sidebar-panel').forEach(p => {
                    p.style.display = 'none';
                    p.classList.remove('active');
                });
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                
                this.classList.add('active');
                const panelId = this.dataset.panel + '-panel';
                const panel = document.getElementById(panelId);
                
                if (panel) {
                    panel.style.display = 'block';
                    panel.classList.add('active');
                    
                    if (this.dataset.panel === 'biblio') {
                        updateUsedElementsDisplay();
                    }
                    
                    // Mettre à jour l'historique quand on clique sur l'onglet
                    if (this.dataset.panel === 'history' && window.app && window.app.uiManager && window.app.uiManager.updateHistoryPanel) {
                        window.app.uiManager.updateHistoryPanel();
                    }
                }
            });
        });

        // Modal show/hide
        document.getElementById('show-elements-library')?.addEventListener('click', () => {
            document.getElementById('elements-modal').style.display = 'block';
        });

        document.getElementById('close-elements-modal')?.addEventListener('click', () => {
            document.getElementById('elements-modal').style.display = 'none';
        });

        // Clic en dehors de la modal pour fermer
        document.getElementById('elements-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'elements-modal') {
                e.target.style.display = 'none';
            }
        });

        updateUsedElementsDisplay();
        
        // Ajouter le gestionnaire pour le bouton Orbite de la toolbar
        document.getElementById('toolbar-view-orbit')?.addEventListener('click', () => {
            console.log('Bouton Orbite cliqué');
            
            // Attendre que l'application soit initialisée
            if (window.app && window.app.controls) {
                const orbitBtn = document.getElementById('toolbar-view-orbit');
                const isCurrentlyEnabled = window.app.controls.enabled;
                
                // Basculer l'état des contrôles
                window.app.controls.enabled = !isCurrentlyEnabled;
                
                // Mettre à jour l'apparence du bouton et l'état global
                if (!isCurrentlyEnabled) {
                    orbitBtn?.classList.add('active');
                    window.lastUsedTool = 'orbit';
                    // Désélectionner tous les outils de la sidebar
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                    console.log('Mode orbite activé');
                } else {
                    orbitBtn?.classList.remove('active');
                    window.lastUsedTool = 'select';
                    // Réactiver le bouton sélection
                    document.getElementById('sidebar-select')?.classList.add('active');
                    console.log('Mode orbite désactivé');
                }
            } else {
                console.log('Application ou contrôles non disponibles');
                // Essayer plus tard si l'app n'est pas encore prête
                setTimeout(() => {
                    if (window.app && window.app.controls) {
                        const orbitBtn = document.getElementById('toolbar-view-orbit');
                        const isCurrentlyEnabled = window.app.controls.enabled;
                        
                        window.app.controls.enabled = !isCurrentlyEnabled;
                        
                        if (!isCurrentlyEnabled) {
                            orbitBtn?.classList.add('active');
                            window.lastUsedTool = 'orbit';
                            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                            console.log('Mode orbite activé (différé)');
                        } else {
                            orbitBtn?.classList.remove('active');
                            window.lastUsedTool = 'select';
                            document.getElementById('sidebar-select')?.classList.add('active');
                            console.log('Mode orbite désactivé (différé)');
                        }
                    }
                }, 1000);
            }
        });
        
        // Gestionnaires d'événements pour le menu Style
        document.getElementById('style-elements-color')?.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.setElementsColorStyle) {
                window.setElementsColorStyle();
            } else {
                console.warn('setElementsColorStyle function not found');
            }
        });
        
        document.getElementById('style-elements-white')?.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.setElementsWhiteStyle) {
                window.setElementsWhiteStyle();
            } else {
                console.warn('setElementsWhiteStyle function not found');
            }
        });

        // Gestion du menu Échelle de cotation (toujours actif même si ouvert par le panneau cotation)
        function setupScaleMenuListeners() {
            const scaleMenu = document.getElementById('dimension-scale-dropdown');
            if (scaleMenu) {
                const scaleOptions = scaleMenu.querySelectorAll('.scale-option');
                scaleOptions.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const scale = parseFloat(option.getAttribute('data-scale'));
                        const scaleText = option.textContent;
                        
                        // Vérifier que l'application et les méthodes existent
                        if (window.app && typeof window.app.setDimensionScale === 'function') {
                            window.app.setDimensionScale(scale, scaleText);
                            
                            // Mettre à jour l'affichage visuel
                            document.querySelectorAll('.scale-option').forEach(opt => opt.classList.remove('active'));
                            option.classList.add('active');
                        } else {
                            console.warn('L\'application n\'est pas encore prête ou la méthode setDimensionScale n\'existe pas');
                            setTimeout(() => {
                                if (window.app && typeof window.app.setDimensionScale === 'function') {
                                    window.app.setDimensionScale(scale, scaleText);
                                    document.querySelectorAll('.scale-option').forEach(opt => opt.classList.remove('active'));
                                    option.classList.add('active');
                                }
                            }, 1000);
                        }
                    });
                });
            }
        }
        setupScaleMenuListeners();
        // Si le menu est réinjecté dynamiquement, réappliquer les listeners
        window.setupScaleMenuListeners = setupScaleMenuListeners;
        
        // Gestionnaires d'événements pour l'importation STL
        document.getElementById('import-stl')?.addEventListener('click', async (e) => {
            e.preventDefault();
            console.log('Import STL clicked from menu');
            if (window.app && window.app.fileManager) {
                try {
                    await window.app.fileManager.importSTLFile();
                } catch (error) {
                    console.error('Erreur lors de l\'importation STL:', error);
                    document.getElementById('command-output').textContent = 'Erreur lors de l\'importation du fichier STL';
                }
            } else {
                console.warn('FileManager non disponible');
                setTimeout(() => {
                    if (window.app && window.app.fileManager) {
                        window.app.fileManager.importSTLFile().catch(error => {
                            console.error('Erreur lors de l\'importation STL:', error);
                        });
                    }
                }, 1000);
            }
        });
        
        // Gestionnaires d'événements pour l'importation SKP
        document.getElementById('import-skp')?.addEventListener('click', async (e) => {
            e.preventDefault();
            console.log('Import SKP clicked from menu');
            if (window.app && window.app.fileManager) {
                window.app.fileManager.showSKPImportInfo();
            } else {
                console.warn('FileManager non disponible');
                setTimeout(() => {
                    if (window.app && window.app.fileManager) {
                        window.app.fileManager.showSKPImportInfo();
                    }
                }, 1000);
            }
        });
        
        document.getElementById('toolbar-import-stl')?.addEventListener('click', async (e) => {
            e.preventDefault();
            console.log('Import STL clicked from toolbar');
            if (window.app && window.app.fileManager) {
                try {
                    await window.app.fileManager.importSTLFile();
                } catch (error) {
                    console.error('Erreur lors de l\'importation STL:', error);
                    document.getElementById('command-output').textContent = 'Erreur lors de l\'importation du fichier STL';
                }
            } else {
                console.warn('FileManager non disponible');
                setTimeout(() => {
                    if (window.app && window.app.fileManager) {
                        window.app.fileManager.importSTLFile().catch(error => {
                            console.error('Erreur lors de l\'importation STL:', error);
                        });
                    }
                }, 1000);
            }
        });
        
        document.getElementById('toolbar-import-skp')?.addEventListener('click', async (e) => {
            e.preventDefault();
            console.log('Import SKP clicked from toolbar');
            if (window.app && window.app.fileManager) {
                window.app.fileManager.showSKPImportInfo();
            } else {
                console.warn('FileManager non disponible');
                setTimeout(() => {
                    if (window.app && window.app.fileManager) {
                        window.app.fileManager.showSKPImportInfo();
                    }
                }, 1000);
            }
        });
    });
    
    // --- Gestion des styles (blanc/couleur) - Portée globale ---
    window.app = window.app || {};
    window.app.originalMaterials = new Map();
    window.app.isWhiteStyleActive = false;
    
    let whiteMeshMaterial, whiteLineMaterial;
    
    function initializeWhiteMaterials() {
        // Wait for app to be fully initialized
        if (!window.app || !window.app.THREE) {
            return false;
        }
        
        const THREE = window.app.THREE;
        
        if (!whiteMeshMaterial) {
            whiteMeshMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xffffff, 
                side: THREE.DoubleSide 
            });
        }
        if (!whiteLineMaterial) {
            whiteLineMaterial = new THREE.LineBasicMaterial({ 
                color: 0xffffff, 
                linewidth: 2 
            });
        }
        console.log('Matériaux blancs initialisés');
        return true;
    }
    
    // Check more frequently and for a longer time
    const checkThreeInterval = setInterval(() => {
        if (window.app && window.app.THREE && initializeWhiteMaterials()) {
            clearInterval(checkThreeInterval);
        }
    }, 100);
    
    setTimeout(() => clearInterval(checkThreeInterval), 20000); // Extended timeout
    
    window.setElementsWhiteStyle = function() {
        if (!window.app || !window.app.scene) {
            console.warn('Application ou scène non disponible');
            document.getElementById('command-output').textContent = 'Erreur: Application non prête';
            return;
        }
        
        if (!window.app.THREE) {
            console.error('THREE.js non disponible dans window.app');
            document.getElementById('command-output').textContent = 'Erreur: THREE.js non disponible';
            return;
        }
        
        if (!window.app.originalMaterials) {
            window.app.originalMaterials = new Map();
        }
        
        if (!whiteMeshMaterial || !whiteLineMaterial) {
            if (!initializeWhiteMaterials()) {
                console.error('Impossible d\'initialiser les matériaux blancs');
                document.getElementById('command-output').textContent = 'Erreur: Matériaux non initialisés';
                return;
            }
        }
        
        if (window.app.isWhiteStyleActive) {
            console.log('Style blanc déjà actif');
            return;
        }
        
        window.app.isWhiteStyleActive = true;
        window.app.originalMaterials.clear();
        
        let objectCount = 0;
        
        // Parcourir tous les objets de la scène
        window.app.scene.traverse((object) => {
            if (object.isMesh || object.isLine || object.isLineSegments) {
                // Ignorer les helpers et grilles
                if (object.name === 'GridHelper' || object.name === 'AxesHelper' || 
                    object.name.includes('Helper') || object.userData?.isHelper ||
                    object.userData?.isAxisIndicator) {
                    return;
                }
                
                // Sauvegarder le matériau original
                if (object.material) {
                    // Gérer les matériaux multiples
                    if (Array.isArray(object.material)) {
                        window.app.originalMaterials.set(object.uuid, object.material.slice());
                        object.material = object.material.map(() => 
                            object.isMesh ? whiteMeshMaterial : whiteLineMaterial
                        );
                    } else {
                        window.app.originalMaterials.set(object.uuid, object.material);
                        if (object.isMesh) {
                            object.material = whiteMeshMaterial;
                        } else if (object.isLine || object.isLineSegments) {
                            object.material = whiteLineMaterial;
                        }
                    }
                    objectCount++;
                }
            }
        });
        
        console.log(`Style blanc appliqué à ${objectCount} objets`);
        
        // Forcer le rendu
        if (window.app.render) {
            window.app.render();
        }
        
        document.getElementById('command-output').textContent = 'Style: Éléments en blancs appliqué';
    }
    
    window.setElementsColorStyle = function() {
        if (!window.app || !window.app.scene) {
            console.warn('Application ou scène non disponible');
           
            document.getElementById('command-output').textContent = 'Erreur: Application non prête';
            return;
        }
        
        if (!window.app.originalMaterials) {
            window.app.originalMaterials = new Map();
        }
        
        if (!window.app.isWhiteStyleActive) { // Corrected condition: if color style is already active (white style is NOT active)
            console.log('Style couleur déjà actif');
            document.getElementById('command-output').textContent = 'Style: Éléments déjà en couleur';
            return;
        }
        
        // Proceed to restore colors because white style was active
        window.app.isWhiteStyleActive = false;
        
        let objectCount = 0;
        
        // Restaurer les matériaux originaux
        window.app.scene.traverse((object) => {
            if (object.isMesh || object.isLine || object.isLineSegments) {
                const originalMaterial = window.app.originalMaterials.get(object.uuid);
                if (originalMaterial) {
                    object.material = originalMaterial;
                    objectCount++;
                }
            }
        });
        
        window.app.originalMaterials.clear();
        
        console.log(`Couleurs restaurées pour ${objectCount} objets`);
        
        // Forcer le rendu
        if (window.app.render) {
            window.app.render();
        }
        
        document.getElementById('command-output').textContent = 'Style: Éléments en couleur restauré';
    }
    </script>
    
    <script>
    // Templates de mode opératoire
    const procedureTemplates = {
        'mur-demi-brique': `1. Préparation & Traçage : Préparez outils/matériaux. Tracez l'emplacement du muret au sol avec un cordeau.
2. Mortier : Mélangez 1 vol. ciment pour 3-4 vol. sable avec de l'eau (consistance souple).
3. 1ère Assise (Cruciale) : Étalez un lit de mortier. Posez la 1ère brique, nivelez-la parfaitement (longueur/largeur).
4. Suite 1ère Assise : Beurrez le bout des briques suivantes, posez-les avec un joint de 1 cm, alignez et nivelez.
5. Assises Suivantes : Montez en décalant les joints verticaux (quinconce) pour la solidité.
6. Pose & Contrôles : Sur chaque assise, étalez le mortier, posez les briques en vérifiant constamment l'alignement (cordeau), le niveau (horizontal) et l'aplomb (vertical).
7. Nettoyage en Cours : Retirez l'excès de mortier frais avec la truelle au fur et à mesure.
8. Préparation Rejointoiement : Laissez le mortier prendre légèrement (ne colle plus au doigt).
9. Rejointoiement : Garnissez les joints avec du mortier frais à l'aide d'un fer à joint, en lissant pour une belle finition.
10. Nettoyage Final : Brossez le muret pour enlever les débris de mortier et nettoyez vos outils.`,
        'mur-bloc-14': `1. Préparation & Traçage : Préparez zone, outils (niveau, truelle, massette, cordeau) et matériaux (blocs de 14, mortier). Tracez l'emplacement au sol.
2. Mortier : Préparez un mortier de maçonnerie (ex: 1 vol. ciment pour 3-4 vol. sable + eau) à consistance onctueuse.
3. 1ère Assise (Fondation) : Étalez un lit de mortier de 2-3 cm. Posez le premier bloc, ajustez-le et nivelez-le parfaitement dans les deux sens.
4. Suite 1ère Assise : Beurrez les "oreilles" (côtés) du bloc suivant. Posez-le contre le premier (joint ~1 cm), alignez et nivelez.
5. Assises Suivantes (Décalage) : Montez les assises en décalant les joints verticaux d'un demi-bloc pour la solidité (appareillage en quinconce).
6. Pose & Contrôles Continus : Sur chaque assise, étalez le mortier. Posez les blocs en vérifiant constamment l'alignement (cordeau), le niveau horizontal et l'aplomb (vertical).
7. Ajustements & Excès : Utilisez la massette pour de légers ajustements si besoin. Enlevez l'excès de mortier avec la truelle.
8. Finition des Joints (Préparation) : Laissez le mortier des joints raffermir (quand il ne s'enfonce plus sous le doigt).
9. Rejointoiement/Lissage : Garnissez et lissez les joints avec une truelle langue de chat ou un fer à joint pour une finition propre.
10. Nettoyage Final : Brossez le muret pour enlever les résidus de mortier et nettoyez soigneusement vos outils.`
    };

    document.getElementById('procedure-template').addEventListener('change', function() {

        const selectedTemplate = this.value;
        const procedureTextarea = document.getElementById('project-procedure');
        if (selectedTemplate && procedureTemplates[selectedTemplate]) {
            procedureTextarea.value = procedureTemplates[selectedTemplate];
        }
    });
    </script>
</body>
</html>
