<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Fix Texture/Color Application</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #2a2a2a;
            color: white;
        }
        
        .container {
            display: flex;
            gap: 20px;
        }
        
        .controls {
            width: 300px;
            background: #3a3a3a;
            padding: 20px;
            border-radius: 8px;
        }
        
        .test-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .test-btn:hover {
            background: #0052cc;
        }
        
        .test-btn.success {
            background: #28a745;
        }
        
        .test-btn.error {
            background: #dc3545;
        }
        
        #log {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }
        .log-info { color: #17a2b8; }
        
        #viewport {
            flex: 1;
            border: 1px solid #555;
            border-radius: 4px;
            background: #1a1a1a;
        }
        
        .status {
            background: #444;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <h3>Test de Correction des Textures/Couleurs</h3>
            
            <div class="status" id="status">Initialisation...</div>
            
            <h4>Tests S√©quentiels</h4>
            <button class="test-btn" onclick="runSequentialTest()">üß™ Lancer Test Complet</button>
            
            <h4>Tests Manuels</h4>
            <button class="test-btn" onclick="initWebCAD()">1. Initialiser WebCAD</button>
            <button class="test-btn" onclick="addTestObject()">2. Ajouter Objet Test</button>
            <button class="test-btn" onclick="testSelectionMode()">3. Test S√©lection</button>
            <button class="test-btn" onclick="testTextureMode()">4. Test Mode Texture</button>
            <button class="test-btn" onclick="testColorMode()">5. Test Mode Couleur</button>
            <button class="test-btn" onclick="clearAll()">üóëÔ∏è Nettoyer</button>
            
            <div id="log"></div>
        </div>
        
        <div id="viewport" style="width: 100%; height: 600px;"></div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import { WebCAD } from './js/core/WebCAD.js';
        
        let app = null;
        let testObject = null;
        
        function setStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        window.initWebCAD = async function() {
            try {
                log('Initialisation de WebCAD...', 'info');
                app = new WebCAD('viewport');
                await new Promise(resolve => setTimeout(resolve, 1000)); // Attendre l'initialisation
                
                if (app.scene && app.renderer && app.camera) {
                    log('‚úÖ WebCAD initialis√© avec succ√®s', 'success');
                    setStatus('WebCAD initialis√©', 'success');
                    return true;
                } else {
                    throw new Error('Composants manquants dans WebCAD');
                }
            } catch (error) {
                log(`‚ùå Erreur initialisation: ${error.message}`, 'error');
                setStatus('Erreur initialisation', 'error');
                return false;
            }
        };
        
        window.addTestObject = function() {
            if (!app) {
                log('‚ùå WebCAD non initialis√©', 'error');
                return false;
            }
            
            try {
                // Cr√©er un cube test
                const geometry = new app.THREE.BoxGeometry(20, 20, 20);
                const material = new app.THREE.MeshPhongMaterial({ color: 0x00ff00 });
                testObject = new app.THREE.Mesh(geometry, material);
                testObject.position.set(0, 0, 10);
                testObject.castShadow = true;
                testObject.receiveShadow = true;
                
                app.scene.add(testObject);
                app.objects.push(testObject);
                
                log('‚úÖ Objet test ajout√© (cube vert)', 'success');
                setStatus('Objet test ajout√©', 'success');
                return true;
            } catch (error) {
                log(`‚ùå Erreur ajout objet: ${error.message}`, 'error');
                return false;
            }
        };
        
        window.testSelectionMode = function() {
            if (!app || !testObject) {
                log('‚ùå WebCAD ou objet test manquant', 'error');
                return false;
            }
            
            try {
                // V√©rifier que le mode texture est d√©sactiv√©
                app.textureApplyMode = false;
                app.selectedTexture = null;
                
                // Simuler un clic sur l'objet pour tester la s√©lection
                if (app.selectionManager && typeof app.selectionManager.selectObject === 'function') {
                    app.selectionManager.selectObject(testObject);
                    log('‚úÖ S√©lection fonctionne', 'success');
                    setStatus('S√©lection OK', 'success');
                    return true;
                } else {
                    throw new Error('SelectionManager non disponible');
                }
            } catch (error) {
                log(`‚ùå Erreur test s√©lection: ${error.message}`, 'error');
                return false;
            }
        };
        
        window.testTextureMode = function() {
            if (!app || !testObject) {
                log('‚ùå WebCAD ou objet test manquant', 'error');
                return false;
            }
            
            try {
                log('Test mode texture...', 'info');
                
                // Activer le mode texture
                app.textureApplyMode = true;
                app.selectedTexture = {
                    name: 'Test Texture',
                    url: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                };
                app.selectedTextureType = 'texture';
                
                // V√©rifier que les m√©thodes existent
                if (typeof app.applyTextureToObject !== 'function') {
                    throw new Error('M√©thode applyTextureToObject manquante');
                }
                
                log('‚úÖ Mode texture activ√©', 'success');
                log('üéØ Cliquez sur le cube pour appliquer la texture', 'warning');
                setStatus('Mode texture actif - cliquez sur le cube', 'warning');
                return true;
            } catch (error) {
                log(`‚ùå Erreur mode texture: ${error.message}`, 'error');
                return false;
            }
        };
        
        window.testColorMode = function() {
            if (!app || !testObject) {
                log('‚ùå WebCAD ou objet test manquant', 'error');
                return false;
            }
            
            try {
                log('Test mode couleur...', 'info');
                
                // Activer le mode couleur
                app.textureApplyMode = true;
                app.selectedTexture = {
                    name: 'Rouge Test',
                    hex: '#ff0000'
                };
                app.selectedTextureType = 'color';
                
                // V√©rifier que les m√©thodes existent
                if (typeof app.applyColorToObject !== 'function') {
                    throw new Error('M√©thode applyColorToObject manquante');
                }
                
                log('‚úÖ Mode couleur activ√©', 'success');
                log('üéØ Cliquez sur le cube pour appliquer la couleur rouge', 'warning');
                setStatus('Mode couleur actif - cliquez sur le cube', 'warning');
                return true;
            } catch (error) {
                log(`‚ùå Erreur mode couleur: ${error.message}`, 'error');
                return false;
            }
        };
        
        window.clearAll = function() {
            if (app) {
                if (testObject) {
                    app.scene.remove(testObject);
                    app.objects = app.objects.filter(obj => obj !== testObject);
                    testObject = null;
                }
                app.textureApplyMode = false;
                app.selectedTexture = null;
                app.selectedTextureType = null;
            }
            
            document.getElementById('log').innerHTML = '';
            log('üóëÔ∏è Nettoyage effectu√©', 'info');
            setStatus('Nettoy√©', 'info');
        };
        
        window.runSequentialTest = async function() {
            log('üöÄ D√©marrage test s√©quentiel complet...', 'info');
            setStatus('Test en cours...', 'warning');
            
            try {
                // Test 1: Initialisation
                if (!await window.initWebCAD()) {
                    throw new Error('√âchec initialisation WebCAD');
                }
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Test 2: Ajout objet
                if (!window.addTestObject()) {
                    throw new Error('√âchec ajout objet test');
                }
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Test 3: S√©lection
                if (!window.testSelectionMode()) {
                    throw new Error('√âchec test s√©lection');
                }
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Test 4: Mode texture
                if (!window.testTextureMode()) {
                    throw new Error('√âchec activation mode texture');
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Test 5: Mode couleur
                if (!window.testColorMode()) {
                    throw new Error('√âchec activation mode couleur');
                }
                
                log('üéâ TOUS LES TESTS PASS√âS AVEC SUCC√àS!', 'success');
                log('üéØ Vous pouvez maintenant cliquer sur le cube pour tester l\'application de couleur', 'warning');
                setStatus('‚úÖ Tests r√©ussis - Testez manuellement', 'success');
                
            } catch (error) {
                log(`‚ùå √âCHEC TEST S√âQUENTIEL: ${error.message}`, 'error');
                setStatus(`‚ùå √âchec: ${error.message}`, 'error');
            }
        };
        
        // Auto-initialisation si demand√©e
        document.addEventListener('DOMContentLoaded', () => {
            log('üîß Test de correction pr√™t', 'info');
            setStatus('Pr√™t pour les tests', 'info');
        });
    </script>
</body>
</html>
